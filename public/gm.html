<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ゲームマスター画面</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #f0f8ff, #e6f7ff);
      color: #333;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #007acc;
    }
    h2 {
      color: #005580;
      margin-top: 30px;
    }
    button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background: #ffffffcc;
      margin: 5px auto;
      padding: 10px;
      border-radius: 8px;
      width: 80%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>ゲームマスター画面</h1>

  <div id="eventButtons">
    <h2>イベントを選択</h2>
    <div id="eventOptions"></div>
  </div>

  <div>
    <h2>ラウンド操作</h2>
    <button onclick="finalizeRound()">ラウンドを確定する</button>
  </div>

  <div>
    <h2>プレイヤー一覧</h2>
    <ul id="playersList"></ul>
  </div>

<div>
  <h2>現在の資産グラフ</h2>
  <canvas id="moneyChart" height="140"></canvas>
</div>

  <div>
    <h2>現在発生中のイベント</h2>
    <ul id="eventLog"></ul>
  </div>


  <!-- ライブラリ読み込み -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const socket = io();
    const activeEvents = [];

    // ===== Chart.js 初期化 =====
    let moneyChart;
    function initMoneyChart() {
      const el = document.getElementById("moneyChart");
      if (!el) return;
      const ctx = el.getContext("2d");
      moneyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [],
          datasets: [{
            label: "現在の資産（万円）",
            data: [],
            borderWidth: 1
          }]
        },
        options: {
          animation: false,
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    }
    function updateMoneyChart(players) {
      if (!moneyChart) return;
      const sorted = [...players].sort((a, b) => b.money - a.money);
      moneyChart.data.labels = sorted.map(p => p.name);
      moneyChart.data.datasets[0].data = sorted.map(p => Number(p.money?.toFixed?.(2) ?? 0));
      moneyChart.update();
    }
    initMoneyChart();
    // ==========================

  // ✅ server.js の eventMap とキーを完全一致
  const allEvents = [
    { key: 'heatWave',           name: '猛暑と電力不足',             details: '電力需要↑・外出減' },
    { key: 'globalOilRise',      name: '世界的な原油高',             details: '資源価格上昇' },
    { key: 'fuelPriceDrop',      name: '燃料価格下落',               details: '原油安・コスト低下' },
    { key: 'usSlowdown',         name: '米国景気減速懸念',           details: 'リスクオフ・利下げ観測' },
    { key: 'tourismRebound',     name: '観光需要回復',               details: '旅行・娯楽需要↑' },
    { key: 'domesticAutoBoom',   name: '国内自動車販売好調',         details: '国内販売＆オートローン増' },
    { key: 'yenHigh',            name: '円高進行',                   details: '輸出採算悪化・外債評価↓' },
    { key: 'recession',          name: '景気後退ムード',             details: '需要減速・債券買い' },
    { key: 'logisticsCostRise',  name: '物流費高騰',                 details: '燃料・人件費↑で配送コスト増' },
    { key: 'nintendoHit',        name: '任天堂の新作が大ヒット',     details: 'ソフト販売＆IP収益↑' },
    { key: 'nintendoMovie',      name: '任天堂が大型映画公開',       details: 'IP露出拡大・関連消費↑' },
    { key: 'consumerSpendingSlump', name: '消費者支出減退',         details: '物価高・実質所得↓で消費抑制' },
    { key: 'bigQuake',           name: '首都圏大地震',               details: 'インフラ混乱・交通停止' },
    { key: 'cryptoCrash',        name: '仮想通貨が暴落',             details: 'リスクオフ・暗号資産売り' },
    { key: 'remoteWork',         name: 'リモートワーク拡大',         details: '通勤減・EC活性' },
    { key: 'cryptoRegTighten',   name: '仮想通貨国際規制強化',       details: '規制強化で資金流出' },
    { key: 'btcETF',             name: 'ビットコインETF承認',       details: '資金流入でBTC急騰' },
    { key: 'btcLegalTender',     name: 'BTCが法定通貨として採用',    details: '採用拡大で普及加速' },
    { key: 'usInfraAct',         name: '米国インフラ投資拡大法成立', details: '財政出動・投資拡大' },
    { key: 'bojQE',              name: '日銀大規模緩和策発表',       details: '長短金利抑制・円安バイアス' },
  ];

  // （任意）GM参加通知：server側に対応ハンドラがあれば初期状態を返してもらえる
  socket.emit("joinAsGM");

  socket.on("gmJoined", () => {
    console.log("GMとして参加しました。");
  });

  // プレイヤーの進捗表示は既存のまま
  socket.on("playerList", (players) => {
    const list = document.getElementById("playersList");
    list.innerHTML = "";
    for (let p of players) {
      const li = document.createElement("li");
      li.textContent = `${p.name}：${p.hasInvested ? "✅ 投資済み" : "⏳ 未投資"}`;
      list.appendChild(li);
    }

 updateMoneyChart(players);
  });

  // ✅ サーバの activeEvents をそのまま反映（初期・更新どちらもOK）
  socket.on("activeEvents", (events) => {
    activeEvents.length = 0;
    activeEvents.push(...events);
    updateEventLog();
  });

 

  function updateEventLog() {
    const log = document.getElementById("eventLog");
    log.innerHTML = "";
    for (let e of activeEvents) {
      const li = document.createElement("li");
      li.textContent = `${e.name}：${e.details}`;
      log.appendChild(li);
    }
  }

  function applyEvent(key) {
    socket.emit("applyEvent", key);
  }

  function finalizeRound() {
    socket.emit("finalizeRound");
  }

  // ボタン生成（serverのeventMapと同じキーでemit）
  const container = document.getElementById("eventOptions");
  for (let ev of allEvents) {
    const btn = document.createElement("button");
    btn.textContent = ev.name;
    btn.title = ev.details;
    btn.onclick = () => applyEvent(ev.key);
    container.appendChild(btn);
  }
</script>

</body>
</html>
